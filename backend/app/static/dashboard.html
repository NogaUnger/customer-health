<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Customer Health Dashboard</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 24px; }
    h1 { margin: 0 0 12px 0; }

    /* Metrics explainer */
    .explainer {
      margin: 6px 0 18px;
      padding: 12px 14px;
      background: #f8f9fb;
      border: 1px solid #e6e8ee;
      border-radius: 10px;
    }
    .explainer h2 {
      margin: 0 0 8px 0;
      font-size: 16px;
      color: #333;
    }
    .explainer p { margin: 0 0 10px 0; color: #555; }
    .explainer ul { margin: 0; padding-left: 18px; color: #444; }
    .explainer li { margin: 6px 0; }

    .toolbar { display: flex; gap: 8px; margin: 8px 0 16px; align-items: center; flex-wrap: wrap; }
    .filter { padding: 6px 10px; border: 1px solid #ddd; border-radius: 8px; background:#fff; cursor:pointer; }
    .filter.active { border-color:#333; font-weight:600; }
    .refresh { margin-left: auto; }
    table { border-collapse: collapse; width: 100%; }
    th, td { padding: 10px 12px; border-bottom: 1px solid #eee; }
    th { text-align: left; font-size: 14px; color: #555; }
    tr:hover { background: #fafafa; cursor: pointer; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; }
    .badge.healthy { background: #e6f4ea; color: #187a2f; }
    .badge.watch { background: #fff4e5; color: #8a5a00; }
    .badge.risk { background: #fdecea; color: #b3261e; }
    .details-row td { background: #f8f9fb; }
    .factor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; margin-top: 8px; }
    .small { color: #666; font-size: 12px; }
    .score { width: 80px; }
    .idcol { width: 70px; color:#666; }
    .muted { color:#777; font-size:12px; }
    @media (max-width: 640px) { .refresh { order: 2; margin-left: 0; } }
  </style>
</head>
<body>
  <h1>Customer Health</h1>

  <!-- Metrics explainer -->
  <div class="explainer">
    <h2>How the score works</h2>
    <p>
      Each customer gets a 0–100 health score, computed as a weighted blend of the factors below.
      Scores are <em>segment/size-aware</em> where relevant (e.g., normalized by seats).
      Click any row to view that customer’s factor breakdown directly beneath it.
    </p>
    <ul>
      <li><strong>Login Frequency (30d)</strong> — engagement level. Normalized by seats and segment targets.</li>
      <li><strong>Feature Adoption (30d)</strong> — breadth of value: distinct core features used.</li>
      <li><strong>Support Ticket Volume (30d)</strong> — product friction. Penalized per 100 seats (fewer is better).</li>
      <li><strong>Invoice Timeliness (≈180d)</strong> — commercial risk, using a <em>recency-weighted</em> paid vs late ratio.</li>
      <li><strong>API Usage Trend (7d vs prev 7d)</strong> — short-term momentum (ratio up/down around neutral).</li>
    </ul>
  </div>

  <div class="toolbar">
    <button class="filter active" data-filter="all">All</button>
    <button class="filter" data-filter="risk">At Risk (bottom 25%)</button>
    <button class="filter" data-filter="watch">Watch (middle 50%)</button>
    <button class="filter" data-filter="healthy">Healthy (top 25%)</button>
    <span id="count" class="muted"></span>
    <button id="refresh" class="refresh">Refresh</button>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th class="idcol">ID</th>
        <th class="score">Score</th>
        <th>Name</th>
        <th>Segment</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <script>
    let customersCache = [];
    let currentFilter = 'all';

    // Absolute coloring so badges remain intuitive at a glance
    function badgeClass(score){ return score >= 80 ? 'healthy' : score >= 40 ? 'watch' : 'risk'; }
    function scoreBadge(score) {
      const span = document.createElement('span');
      span.className = 'badge ' + badgeClass(score);
      span.textContent = Number(score).toFixed(1);
      return span;
    }
    function labelize(key) { return key.replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase()); }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
    }

    // Relative thresholds (percentiles): bottom 25%, middle 50%, top 25%
    function thresholds() {
      const scores = customersCache.map(c => Number(c.health_score || 0)).sort((a,b)=>a-b);
      if (!scores.length) return { q25: 40, q75: 80 };
      const idx25 = Math.floor(0.25 * (scores.length - 1));
      const idx75 = Math.floor(0.75 * (scores.length - 1));
      return { q25: scores[idx25], q75: scores[idx75] };
    }

    function matchesFilter(score, q) {
      if (currentFilter === 'all') return true;
      if (currentFilter === 'risk')   return score < q.q25;
      if (currentFilter === 'watch')  return score >= q.q25 && score < q.q75;
      if (currentFilter === 'healthy')return score >= q.q75;
      return true;
    }

    function render() {
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      if (!customersCache.length) {
        const tr = document.createElement('tr');
        const td = document.createElement('td'); td.colSpan = 4; td.textContent = 'No data.';
        tr.appendChild(td); tbody.appendChild(tr);
        return;
      }

      const q = thresholds();

      // sort ASC by score (lowest first)
      const data = customersCache.slice().sort((a,b) => (a.health_score ?? 0) - (b.health_score ?? 0));

      // counts by relative buckets
      const counts = { all: data.length, risk:0, watch:0, healthy:0 };
      for (const c of data) {
        const s = Number(c.health_score || 0);
        if (s < q.q25) counts.risk++; else if (s < q.q75) counts.watch++; else counts.healthy++;
      }
      document.getElementById('count').textContent =
        `Showing ${currentFilter==='all'?counts.all:counts[currentFilter]} of ${counts.all} (q25=${q.q25.toFixed(1)}, q75=${q.q75.toFixed(1)})`;

      for (const c of data) {
        const score = Number(c.health_score || 0);
        if (!matchesFilter(score, q)) continue;

        const tr = document.createElement('tr');
        tr.dataset.id = c.id;

        const tdId    = document.createElement('td'); tdId.textContent = c.id; tdId.className='idcol'; tr.appendChild(tdId);
        const tdScore = document.createElement('td'); tdScore.appendChild(scoreBadge(score)); tr.appendChild(tdScore);
        const tdName  = document.createElement('td'); tdName.textContent = c.name; tr.appendChild(tdName);
        const tdSeg   = document.createElement('td'); tdSeg.textContent = c.segment; tr.appendChild(tdSeg);

        tr.addEventListener('click', () => toggleDetails(tr, c.id, c.name));
        tbody.appendChild(tr);
      }
    }

    async function load() {
      const btn = document.getElementById('refresh');
      btn.disabled = true; btn.textContent = 'Loading...';
      try {
        const res = await fetch('/api/customers');
        customersCache = await res.json();
        render();
      } catch (e) {
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '<tr><td colspan="4">Failed to load customers.</td></tr>';
      } finally {
        btn.disabled = false; btn.textContent = 'Refresh';
      }
    }

    async function toggleDetails(row, id, name) {
      const next = row.nextElementSibling;
      if (next && next.classList.contains('details-row')) { next.remove(); return; }

      const detailsTr = document.createElement('tr');
      detailsTr.className = 'details-row';
      const td = document.createElement('td'); td.colSpan = 4;
      td.innerHTML = `<div class="small">Loading breakdown for <strong>${escapeHtml(name)}</strong> (ID ${id})…</div>`;
      detailsTr.appendChild(td);
      row.insertAdjacentElement('afterend', detailsTr);

      try {
        const res = await fetch(`/api/customers/${id}/health`);
        const breakdown = await res.json();
        const factors = breakdown.factors || {};
        td.innerHTML = `
          <div><strong>${escapeHtml(name)}</strong> (ID ${id}) — Total:
            <span class="badge ${badgeClass(breakdown.total)}">${Number(breakdown.total).toFixed(1)}</span>
          </div>
          <div class="factor-grid">
            ${Object.entries(factors).map(([k,v]) => `
              <div>
                <div class="small">${escapeHtml(labelize(k))}</div>
                <div><span class="badge ${badgeClass(v)}">${Number(v).toFixed(1)}</span></div>
              </div>
            `).join('')}
          </div>
        `;
      } catch {
        td.innerHTML = `<div class="small" style="color:#b3261e">Failed to load breakdown.</div>`;
      }
    }

    // filter buttons
    document.querySelectorAll('.filter').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        render();
      });
    });

    document.getElementById('refresh').addEventListener('click', load);
    load();
  </script>
</body>
</html>
