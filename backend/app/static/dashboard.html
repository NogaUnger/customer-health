<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Customer Health Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{
      --bg:#ffffff; --text:#0f172a; --muted:#64748b; --border:#e5e7eb; --card:#ffffff;
      --accent:#2563eb;
      --ok:#16a34a; --warn:#f59e0b; --risk:#ef4444;
      --pill:#f1f5f9; --row:#ffffff; --rowAlt:#fafafa;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{padding:28px 20px 8px}
    h1{margin:0 0 8px;font-size:28px;letter-spacing:.3px}
    .sub{color:var(--muted);max-width:980px;line-height:1.5}
    .shell{padding:10px 20px 40px}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px 14px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .controls{display:grid;gap:10px;grid-template-columns:repeat(12, minmax(0,1fr));align-items:end}
    .controls .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted)}
    input[type="text"], select {height:38px;border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--text);padding:0 10px;outline:none}
    input[type="range"]{accent-color:var(--accent)}
    .btn{height:38px;border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--text);padding:0 12px;cursor:pointer}
    .btn:hover{background:#f8fafc}
    .btn.ghost{background:transparent}
    .btn.active{outline:2px solid var(--accent)}
    .badges{display:flex;gap:6px;align-items:center}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted);background:#fff}
    .risk-pill{font-weight:600;color:#fff;padding:4px 10px;border-radius:999px}
    .risk-low{background:var(--risk)}
    .risk-mid{background:var(--warn);color:#111}
    .risk-high{background:var(--ok)}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);text-align:left;padding:0 12px}
    tbody tr.data-row{background:linear-gradient(180deg,var(--row),var(--rowAlt));border:1px solid var(--border)}
    tbody tr td{padding:12px}
    tbody tr.data-row td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody tr.data-row td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    .score-pill{display:inline-block;background:var(--pill);border:1px solid var(--border);padding:4px 10px;border-radius:999px;font-weight:600}
    .seg{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#eef2ff;color:#334155}
    .actions{display:flex;gap:8px}
    .expand{cursor:pointer}
    .expanded-cell{background:#f8fafc;border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:-4px}
    .expanded-grid{display:grid;grid-template-columns:420px 1fr;gap:16px}
    .mini{font-size:12px;color:var(--muted)}
    .empty, .error, .loading{color:var(--muted);padding:16px;text-align:center}
    .pagination{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px}
    .link{color:var(--accent);text-decoration:none}
    .sticky-controls{position:sticky;top:0;z-index:10;padding-top:10px;background:linear-gradient(180deg,#ffffff 70%, transparent)}
    .grid{display:grid;gap:12px;grid-template-columns:2fr 1fr}
    .cards{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
    .card-kpi{border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff}
    .kpi-title{font-size:12px;color:var(--muted)}
    .kpi-value{font-size:22px;font-weight:700;margin-top:2px}
    @media (max-width:1000px){ .grid{grid-template-columns:1fr} }
    @media (max-width:900px){ .expanded-grid{grid-template-columns:1fr} .controls{grid-template-columns:1fr 1fr}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1>Customer Health</h1>
    <p class="sub">
      Scores blend <b>Login Frequency</b>, <b>Feature Adoption</b>, <b>Ticket Volume</b>,
      <b>Invoice Timeliness</b>, and <b>API Usage Trend</b>. Higher is better (0–100).
      Use the controls to search, filter, and sort. Click a row for a breakdown (donut + bars).
    </p>
  </header>

  <div class="shell">
    <div class="grid">
      <div class="panel">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <div style="font-weight:600">Overall Health Trend (last 30 days)</div>
          <div>
            <select id="trend-segment" class="btn" style="height:32px">
              <option value="">All segments</option>
              <option value="startup">Startup</option>
              <option value="smb">SMB</option>
              <option value="enterprise">Enterprise</option>
            </select>
          </div>
        </div>
        <canvas id="trendChart" height="110"></canvas>
      </div>

      <div class="panel">
        <div style="font-weight:600;margin-bottom:8px">At-a-glance</div>
        <div class="cards">
          <div class="card-kpi">
            <div class="kpi-title">Customers</div>
            <div id="kpi-total" class="kpi-value">—</div>
          </div>
          <div class="card-kpi">
            <div class="kpi-title">Avg Score (today)</div>
            <div id="kpi-avg" class="kpi-value">—</div>
          </div>
          <div class="card-kpi">
            <div class="kpi-title">Healthy / Watch / At Risk</div>
            <div id="kpi-risk" class="kpi-value">—</div>
          </div>
        </div>
        <div class="mini" style="margin-top:10px">Risk distribution</div>
        <div id="risk-bar" style="height:10px;border:1px solid var(--border);border-radius:999px;overflow:hidden;background:#fff">
          <div id="rb-green" style="height:100%;width:0;background:var(--ok);float:left"></div>
          <div id="rb-yellow" style="height:100%;width:0;background:var(--warn);float:left"></div>
          <div id="rb-red" style="height:100%;width:0;background:var(--risk);float:left"></div>
        </div>
      </div>
    </div>

    <!-- CONTROLS -->
    <div class="sticky-controls panel" style="margin-top:12px">
      <div class="controls">
        <div class="field" style="grid-column:span 3">
          <label for="search">Search by name</label>
          <input id="search" list="name-suggest" type="text" placeholder="Start typing a name…">
          <datalist id="name-suggest"></datalist>
        </div>
        <div class="field" style="grid-column:span 2">
          <label for="segment">Segment</label>
          <select id="segment">
            <option value="">All</option>
            <option value="startup">Startup</option>
            <option value="smb">SMB</option>
            <option value="enterprise">Enterprise</option>
          </select>
        </div>
        <div class="field" style="grid-column:span 3">
          <label>Risk</label>
          <div class="badges">
            <button class="btn ghost risk-filter active" data-risk="all">All <span id="count-all" class="badge">0</span></button>
            <button class="btn ghost risk-filter" data-risk="at_risk">At Risk <span id="count-risk" class="badge">0</span></button>
            <button class="btn ghost risk-filter" data-risk="watch">Watch <span id="count-watch" class="badge">0</span></button>
            <button class="btn ghost risk-filter" data-risk="healthy">Healthy <span id="count-healthy" class="badge">0</span></button>
          </div>
        </div>
        <div class="field" style="grid-column:span 2">
          <label>Score range</label>
          <div style="display:flex;gap:8px;align-items:center">
            <span id="score-min-label" class="badge">0</span>
            <input id="score-min" type="range" min="0" max="100" value="0" step="1" style="width:120px">
            <input id="score-max" type="range" min="0" max="100" value="100" step="1" style="width:120px">
            <span id="score-max-label" class="badge">100</span>
          </div>
        </div>
        <div class="field" style="grid-column:span 2">
          <label for="sort">Sort</label>
          <div style="display:flex;gap:8px">
            <select id="sort">
              <option value="health_score">Score</option>
              <option value="name">Name</option>
              <option value="id">ID</option>
            </select>
            <button id="order" class="btn" title="Toggle order">Asc</button>
          </div>
        </div>
        <div class="field" style="grid-column:span 2">
          <label for="page-size">Page size</label>
          <select id="page-size">
            <option>10</option>
            <option>25</option>
            <option selected>50</option>
            <option>100</option>
          </select>
        </div>
        <div class="field" style="grid-column:span 12;display:flex;gap:8px;justify-content:flex-end">
          <button id="export" class="btn">Export CSV (current view)</button>
        </div>
      </div>
    </div>

    <div id="status" class="loading" style="display:none">Loading…</div>
    <div id="error" class="error" style="display:none">Could not load customers. Try again.</div>
    <div id="empty" class="empty" style="display:none">No customers match your filters.</div>

    <div class="panel" style="margin-top:12px">
      <table>
        <thead>
          <tr>
            <th style="width:70px">ID</th>
            <th>Name</th>
            <th style="width:140px">Segment</th>
            <th style="width:160px">Company Size</th>
            <th style="width:120px">Risk</th>
            <th style="width:120px">Score</th>
            <th style="width:120px">Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="pagination">
        <span id="page-label" class="badge">Page 1</span>
        <button id="prev" class="btn">Prev</button>
        <button id="next" class="btn">Next</button>
      </div>
    </div>
  </div>

  <script>
    // ---- constants (absolute thresholds as requested) ----
    const RISK_THRESH = { red: 60, green: 80 }; // <60 red, 60-79 yellow, >=80 green
    const WEIGHTS = { login_frequency:.25, feature_adoption:.20, support_ticket_volume:.25, invoice_timeliness:.20, api_usage_trend:.10 };

    // ---- app state ----
    const state = {
      q:"", segment:"", risk:"all",
      min:0, max:100,
      sort:"health_score", order:"asc",
      pageSize:50, page:1,
      allRows:[], // full dataset (fetched once)
      viewRows:[], // filtered + sorted
      charts:new Map(),
      breakdownCache:new Map()
    };

    // ---- elements ----
    const $tbody = document.getElementById("tbody");
    const $pageLabel = document.getElementById("page-label");
    const $btnPrev = document.getElementById("prev");
    const $btnNext = document.getElementById("next");

    // ---- utils ----
    const debounce = (fn,ms)=>{let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};
    const fmtScore = s => (s==null?"—":Math.round(s));
    const segBadge = s => `<span class="seg">${s}</span>`;
    const humanSize = (seats)=>{
      const n = Number(seats||0);
      if(!n) return "Unknown";
      if(n<=10) return "1–10 (Micro)";
      if(n<=50) return "11–50 (Small)";
      if(n<=200) return "51–200 (Medium)";
      if(n<=1000) return "201–1000 (Large)";
      return "1000+ (Enterprise)";
    };
    const riskBucket = score=>{
      if(score==null) return "watch";
      if(score < RISK_THRESH.red) return "at_risk";
      if(score < RISK_THRESH.green) return "watch";
      return "healthy";
    };
    function scorePill(score){
      const b = riskBucket(score);
      const cls = b==="healthy"?"risk-high":(b==="watch"?"risk-mid":"risk-low");
      return `<span class="score-pill ${cls}">${fmtScore(score)}</span>`;
    }

    // ---- loading + trend ----
    let trendChart;
    async function loadTrend() {
      const seg = document.getElementById("trend-segment").value || "";
      const url = new URL(location.origin + "/api/health/trend");
      url.searchParams.set("days", 30);
      if (seg) url.searchParams.set("segment", seg);
      const r = await fetch(url.toString());
      if (!r.ok) return;
      const data = await r.json();
      const labels = data.map(p=>p.date);
      const avg = data.map(p=>p.avg);
      const p25 = data.map(p=>p.p25);
      const p75 = data.map(p=>p.p75);
      const ctx = document.getElementById("trendChart").getContext("2d");
      if (trendChart) trendChart.destroy();
      trendChart = new Chart(ctx, {
        type:"line",
        data:{ labels,
          datasets:[
            { label:"Avg", data:avg, borderWidth:2, tension:.4, fill:true, backgroundColor:"rgba(37,99,235,.08)", borderColor:"#2563eb" },
            { label:"P25", data:p25, borderWidth:1, borderDash:[4,4], tension:.4, fill:false, borderColor:"#ef4444" },
            { label:"P75", data:p75, borderWidth:1, borderDash:[4,4], tension:.4, fill:false, borderColor:"#16a34a" },
          ]},
        options:{
          responsive:true,
          plugins:{ legend:{labels:{color:"#334155"}} },
          scales:{
            x:{ ticks:{color:"#64748b"}, grid:{color:"rgba(0,0,0,.05)"} },
            y:{ min:0,max:100,ticks:{color:"#64748b"}, grid:{color:"rgba(0,0,0,.05)"} }
          }
        }
      });
      if (data.length){
        const last = data[data.length-1];
        document.getElementById("kpi-avg").textContent = Math.round(last.avg);
      }
    }
    document.getElementById("trend-segment").addEventListener("change", loadTrend);

    // ---- fetch all customers once, then filter client-side ----
    async function fetchAll() {
      const pageLimit = 200;
      let offset = 0, all = [];
      while(true){
        const u = new URL(location.origin + "/api/customers");
        u.searchParams.set("limit", pageLimit);
        u.searchParams.set("offset", offset);
        // we intentionally do NOT pass filters; client-side handles them
        const res = await fetch(u.toString());
        if(!res.ok) throw new Error("customers fetch failed");
        const chunk = await res.json();
        all = all.concat(chunk);
        if (chunk.length < pageLimit) break;
        offset += pageLimit;
      }
      state.allRows = all;
      // fill name suggestions
      const dl = document.getElementById("name-suggest");
      dl.innerHTML = "";
      [...new Set(all.map(r=>r.name))].sort().forEach(n=>{
        const opt = document.createElement("option"); opt.value=n; dl.appendChild(opt);
      });
      updateAtGlance(all);
    }

    // ---- At-a-glance cards & bar ----
    function updateAtGlance(arr){
      document.getElementById("kpi-total").textContent = arr.length;
      const counts = { healthy:0, watch:0, at_risk:0 };
      arr.forEach(r=>counts[riskBucket(r.health_score || 0)]++);
      const tot = Math.max(1, arr.length);
      document.getElementById("kpi-risk").textContent =
        `${counts.healthy}/${counts.watch}/${counts.at_risk}`;
      document.getElementById("rb-green").style.width = `${(counts.healthy/tot)*100}%`;
      document.getElementById("rb-yellow").style.width = `${(counts.watch/tot)*100}%`;
      document.getElementById("rb-red").style.width = `${(counts.at_risk/tot)*100}%`;
    }

    // ---- build filtered/sorted view ----
    function applyFilters(){
      let rows = [...state.allRows];

      // text search (case-insensitive substring)
      if (state.q) {
        const q = state.q.toLowerCase();
        rows = rows.filter(r => (r.name||"").toLowerCase().includes(q));
      }

      // segment
      if (state.segment) rows = rows.filter(r => (r.segment||"") === state.segment);

      // risk bucket
      if (state.risk !== "all") rows = rows.filter(r => riskBucket(r.health_score||0) === state.risk);

      // score range
      rows = rows.filter(r => {
        const s = r.health_score ?? 0;
        return s >= state.min && s <= state.max;
      });

      // sort
      rows.sort((a,b)=>{
        const key = state.sort;
        let va = a[key], vb = b[key];
        if (key === "name") { va = (va||"").toLowerCase(); vb = (vb||"").toLowerCase(); }
        if (va < vb) return state.order==="asc" ? -1 : 1;
        if (va > vb) return state.order==="asc" ? 1 : -1;
        return 0;
      });

      state.viewRows = rows;
      renderPage();
      updateCounters();
    }

    // ---- counters in filter buttons ----
    function updateCounters(){
      const total = state.viewRows.length;
      const risk = state.viewRows.filter(r=>riskBucket(r.health_score||0)==="at_risk").length;
      const watch = state.viewRows.filter(r=>riskBucket(r.health_score||0)==="watch").length;
      const healthy = state.viewRows.filter(r=>riskBucket(r.health_score||0)==="healthy").length;
      document.getElementById("count-all").textContent = total;
      document.getElementById("count-risk").textContent = risk;
      document.getElementById("count-watch").textContent = watch;
      document.getElementById("count-healthy").textContent = healthy;
    }

    // ---- pagination + render ----
    function renderPage(){
      const start = (state.page-1)*state.pageSize;
      const rows = state.viewRows.slice(start, start+state.pageSize);

      $tbody.innerHTML = "";
      if (!rows.length){
        document.getElementById("empty").style.display = "block";
      } else {
        document.getElementById("empty").style.display = "none";
      }

      for (const r of rows){
        const tr = document.createElement("tr");
        tr.className = "data-row";
        tr.id = `row-${r.id}`;
        const riskTxt = riskBucket(r.health_score||0)
          .replace("at_risk","At Risk").replace("watch","Watch").replace("healthy","Healthy");
        tr.innerHTML = `
          <td>${r.id}</td>
          <td>${r.name}</td>
          <td>${segBadge(r.segment)}</td>
          <td>${humanSize(r.seats)}</td>
          <td>${riskTxt}</td>
          <td>${scorePill(r.health_score)}</td>
          <td class="actions">
            <button class="btn expand" data-id="${r.id}">Details</button>
            <a class="link" href="#customer-${r.id}" title="Copy link">Link</a>
          </td>
        `;
        $tbody.appendChild(tr);

        const exp = document.createElement("tr");
        exp.id = `expand-${r.id}`;
        exp.innerHTML = `<td colspan="7"><div class="expanded-cell" style="display:none"></div></td>`;
        $tbody.appendChild(exp);
      }

      // wire expanders
      document.querySelectorAll(".expand").forEach(btn=>{
        btn.onclick = async (e)=>{
          const id = Number(e.currentTarget.dataset.id);
          await toggleExpand(id);
        };
      });

      $pageLabel.textContent = `Page ${state.page} of ${Math.max(1, Math.ceil(state.viewRows.length/state.pageSize))}`;
      $btnPrev.disabled = state.page<=1;
      $btnNext.disabled = state.page >= Math.ceil(state.viewRows.length/state.pageSize);
    }

    function destroyChart(id){
      const ch = state.charts.get(id);
      if (ch){ ch.destroy(); state.charts.delete(id); }
    }

    function renderBreakdown(id, cell, factors){
      const labels = ["login_frequency","feature_adoption","support_ticket_volume","invoice_timeliness","api_usage_trend"];
      const pretty = {
        login_frequency:"Login Frequency",
        feature_adoption:"Feature Adoption",
        support_ticket_volume:"Ticket Volume",
        invoice_timeliness:"Invoice Timeliness",
        api_usage_trend:"API Usage Trend"
      };
      const data = labels.map(k => Math.round(factors[k] ?? 0));
      const contrib = labels.map(k => (factors[k] ?? 0) * WEIGHTS[k]);

      cell.innerHTML = `
        <div class="expanded-grid">
          <div>
            <canvas id="donut-${id}" data-chart="${id}" height="220"></canvas>
          </div>
          <div>
            ${labels.map((k,i)=>`
              <div style="display:flex;align-items:center;gap:10px;margin:8px 0">
                <div style="width:200px;color:#475569">${pretty[k]} (${Math.round(WEIGHTS[k]*100)}%)</div>
                <div style="flex:1;background:#e2e8f0;border:1px solid #e5e7eb;border-radius:999px;overflow:hidden;height:8px">
                  <div style="height:100%;width:${data[i]}%;background:linear-gradient(90deg,#2563eb,#22c55e)"></div>
                </div>
                <div style="width:40px;text-align:right">${data[i]}</div>
              </div>
            `).join("")}
            <div class="mini" style="margin-top:8px">Donut shows weighted contribution of each factor to the total.</div>
          </div>
        </div>
      `;
      const ctx = document.getElementById(`donut-${id}`).getContext("2d");
      const chart = new Chart(ctx, {
        type: "doughnut",
        data: { labels: labels.map(k=>pretty[k]), datasets: [{ data: contrib, borderWidth: 0 }] },
        options: {
          responsive: true,
          plugins: { legend:{position:"bottom"}, tooltip:{enabled:true} },
          cutout: "60%"
        }
      });
      state.charts.set(id, chart);
    }

    async function toggleExpand(id){
      const cell = document.querySelector(`#expand-${id} .expanded-cell`);
      const opened = cell.style.display !== "none";
      if (opened){ cell.style.display="none"; destroyChart(id); return; }

      // close others
      document.querySelectorAll(".expanded-cell").forEach(n=>{
        if (n!==cell){ n.style.display="none"; }
      });
      document.querySelectorAll("canvas[data-chart]").forEach(c=>{
        const cid = Number(c.dataset.chart);
        destroyChart(cid);
      });

      cell.style.display="block";
      let factors = state.breakdownCache.get(id);
      if (!factors){
        const r = await fetch(`/api/customers/${id}/health`);
        if (!r.ok){ cell.innerHTML = `<div class="mini">Failed to load breakdown.</div>`; return; }
        const body = await r.json();
        factors = body.factors || {};
        state.breakdownCache.set(id, factors);
      }
      renderBreakdown(id, cell, factors);
      history.replaceState(null, "", `#customer-${id}`);
    }

    // ---- controls wiring ----
    document.getElementById("search").addEventListener("input", debounce(e=>{
      state.q = e.target.value.trim(); state.page=1; applyFilters();
    }, 150));
    document.getElementById("segment").addEventListener("change", e=>{
      state.segment = e.target.value; state.page=1; applyFilters();
    });
    document.querySelectorAll(".risk-filter").forEach(b=>{
      b.addEventListener("click", ()=>{
        document.querySelectorAll(".risk-filter").forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
        state.risk = b.dataset.risk; state.page=1; applyFilters();
      });
    });
    document.getElementById("score-min").addEventListener("input", e=>{
      state.min = Number(e.target.value);
      if (state.min > state.max){ state.min = state.max; e.target.value = state.min; }
      document.getElementById("score-min-label").textContent = state.min;
      state.page=1; applyFilters();
    });
    document.getElementById("score-max").addEventListener("input", e=>{
      state.max = Number(e.target.value);
      if (state.max < state.min){ state.max = state.min; e.target.value = state.max; }
      document.getElementById("score-max-label").textContent = state.max;
      state.page=1; applyFilters();
    });
    document.getElementById("sort").addEventListener("change", e=>{
      state.sort = e.target.value; state.page=1; applyFilters();
    });
    document.getElementById("order").addEventListener("click", ()=>{
      state.order = state.order==="asc" ? "desc" : "asc";
      document.getElementById("order").textContent = state.order==="asc" ? "Asc" : "Desc";
      state.page=1; applyFilters();
    });
    document.getElementById("page-size").addEventListener("change", e=>{
      state.pageSize = Number(e.target.value); state.page=1; renderPage();
    });
    $btnPrev.addEventListener("click", ()=>{ state.page = Math.max(1, state.page-1); renderPage(); });
    $btnNext.addEventListener("click", ()=>{ state.page = Math.min(Math.ceil(state.viewRows.length/state.pageSize), state.page+1); renderPage(); });

    document.getElementById("export").addEventListener("click", ()=>{
      const start = (state.page-1)*state.pageSize;
      const rows = state.viewRows.slice(start, start+state.pageSize);
      const header = ["id","name","segment","company_size","risk","health_score"];
      const csv = [header.join(",")].concat(rows.map(r =>
        [r.id, JSON.stringify(r.name), r.segment, JSON.stringify(humanSize(r.seats)), riskBucket(r.health_score||0), Math.round(r.health_score ?? 0)].join(",")
      )).join("\n");
      const blob = new Blob([csv], {type:"text/csv"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "customers.csv";
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // ---- init ----
    (async function init(){
      await Promise.all([fetchAll(), loadTrend()]);
      applyFilters();
    })();
  </script>
</body>
</html>
