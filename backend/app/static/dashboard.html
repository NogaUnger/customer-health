<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Customer Health Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --ok:#16a34a; --warn:#eab308; --risk:#ef4444; --pill:#1f2937; --accent:#38bdf8;
      --row:#0b1224; --rowAlt:#0d152b; --border:#22304a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#0b1224, #0f172a 60%);}
    header{padding:28px 20px 8px;color:var(--text)}
    h1{margin:0 0 8px;font-size:28px;letter-spacing:.3px}
    .sub{color:var(--muted);max-width:900px;line-height:1.5}
    .shell{padding:10px 20px 40px}
    .panel{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:14px;padding:14px 14px}
    .controls{display:grid;gap:10px;grid-template-columns:repeat(12, minmax(0,1fr));align-items:end}
    .controls .field{display:flex;flex-direction:column;gap:6px;color:var(--text)}
    label{font-size:12px;color:var(--muted)}
    input[type="text"], select {height:36px;border-radius:10px;border:1px solid var(--border);background:#0b1326;color:var(--text);padding:0 10px;outline:none}
    input[type="range"]{accent-color:var(--accent)}
    .btn{height:36px;border-radius:10px;border:1px solid var(--border);background:#0b1326;color:var(--text);padding:0 12px;cursor:pointer}
    .btn:hover{background:#0e1934}
    .btn.ghost{background:transparent}
    .btn.active{outline:2px solid var(--accent)}
    .badges{display:flex;gap:6px;align-items:center}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted);background:#0b1326}
    .risk-pill{font-weight:600;color:#fff;padding:4px 10px;border-radius:999px}
    .risk-low{background:var(--risk)}
    .risk-mid{background:var(--warn);color:#111}
    .risk-high{background:var(--ok)}
    table{width:100%;border-collapse:separate;border-spacing:0 8px;color:var(--text)}
    thead th{font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);text-align:left;padding:0 12px}
    tbody tr.data-row{background:linear-gradient(180deg,var(--row),var(--rowAlt));border:1px solid var(--border)}
    tbody tr td{padding:12px}
    tbody tr.data-row td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody tr.data-row td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    .score-pill{display:inline-block;background:var(--pill);border:1px solid var(--border);padding:4px 10px;border-radius:999px;font-weight:600}
    .seg{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#0c1731;color:var(--muted)}
    .actions{display:flex;gap:8px}
    .expand{cursor:pointer}
    .expanded-cell{background:#0b1326;border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:-4px}
    .expanded-grid{display:grid;grid-template-columns:420px 1fr;gap:16px}
    .mini{font-size:12px;color:var(--muted)}
    .empty, .error, .loading{color:var(--muted);padding:16px;text-align:center}
    .pagination{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px}
    .link{color:var(--accent);text-decoration:none}
    .sticky-controls{position:sticky;top:0;z-index:10;padding-top:10px;background:linear-gradient(180deg,#0b1224 70%, transparent)}
    .grid{display:grid;gap:12px;grid-template-columns:2fr 1fr}
    @media (max-width:1000px){ .grid{grid-template-columns:1fr} }
    @media (max-width:900px){ .expanded-grid{grid-template-columns:1fr} .controls{grid-template-columns:1fr 1fr}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1>Customer Health</h1>
    <p class="sub">
      Scores blend multiple signals: <b>Login Frequency</b>, <b>Feature Adoption</b>, <b>Ticket Volume</b>,
      <b>Invoice Timeliness</b>, and <b>API Usage Trend</b>. Higher is better (0–100).
      Use the controls to search, filter, and sort. Click a row for a breakdown (donut + bars).
    </p>
  </header>

  <div class="shell">
    <div class="grid">
      <div class="panel">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <div style="color:#e5e7eb;font-weight:600">Overall Health Trend (last 30 days)</div>
          <div>
            <select id="trend-segment" class="btn" style="height:32px">
              <option value="">All segments</option>
              <option value="startup">Startup</option>
              <option value="smb">SMB</option>
              <option value="enterprise">Enterprise</option>
            </select>
          </div>
        </div>
        <canvas id="trendChart" height="120"></canvas>
      </div>

      <div class="panel">
        <div style="color:#e5e7eb;font-weight:600;margin-bottom:8px">At-a-glance</div>
        <div id="glance" class="mini">Loading…</div>
      </div>
    </div>

    <!-- CONTROLS -->
    <div class="sticky-controls panel" style="margin-top:12px">
      <div class="controls">
        <div class="field" style="grid-column:span 3">
          <label for="search">Search by name</label>
          <input id="search" type="text" placeholder="e.g. acme, rocket, cloud...">
        </div>
        <div class="field" style="grid-column:span 2">
          <label for="segment">Segment</label>
          <select id="segment">
            <option value="">All</option>
            <option value="startup">Startup</option>
            <option value="smb">SMB</option>
            <option value="enterprise">Enterprise</option>
          </select>
        </div>
        <div class="field" style="grid-column:span 3">
          <label>Risk</label>
          <div class="badges">
            <button class="btn ghost risk-filter active" data-risk="all">All <span id="count-all" class="badge">0</span></button>
            <button class="btn ghost risk-filter" data-risk="at_risk">At Risk <span id="count-risk" class="badge">0</span></button>
            <button class="btn ghost risk-filter" data-risk="watch">Watch <span id="count-watch" class="badge">0</span></button>
            <button class="btn ghost risk-filter" data-risk="healthy">Healthy <span id="count-healthy" class="badge">0</span></button>
          </div>
        </div>
        <div class="field" style="grid-column:span 2">
          <label>Score range</label>
          <div style="display:flex;gap:8px;align-items:center">
            <span id="score-min-label" class="badge">0</span>
            <input id="score-min" type="range" min="0" max="100" value="0" step="1" style="width:120px">
            <input id="score-max" type="range" min="0" max="100" value="100" step="1" style="width:120px">
            <span id="score-max-label" class="badge">100</span>
          </div>
        </div>
        <div class="field" style="grid-column:span 2">
          <label for="sort">Sort</label>
          <div style="display:flex;gap:8px">
            <select id="sort">
              <option value="health_score">Score</option>
              <option value="name">Name</option>
              <option value="id">ID</option>
            </select>
            <button id="order" class="btn" title="Toggle order">Asc</button>
          </div>
        </div>
        <div class="field" style="grid-column:span 2">
          <label for="page-size">Page size</label>
          <select id="page-size">
            <option>10</option>
            <option>25</option>
            <option selected>50</option>
            <option>100</option>
          </select>
        </div>
        <div class="field" style="grid-column:span 12;display:flex;gap:8px;justify-content:flex-end">
          <button id="export" class="btn">Export CSV (current view)</button>
        </div>
      </div>
    </div>

    <div id="status" class="loading" style="display:none">Loading…</div>
    <div id="error" class="error" style="display:none">Could not load customers. Try again.</div>
    <div id="empty" class="empty" style="display:none">No customers match your filters.</div>

    <div class="panel" style="margin-top:12px">
      <table>
        <thead>
          <tr>
            <th style="width:70px">ID</th>
            <th>Name</th>
            <th style="width:140px">Segment</th>
            <th style="width:110px">Seats</th>
            <th style="width:140px">Score</th>
            <th style="width:120px">Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="pagination">
        <span id="page-label" class="badge">Page 1</span>
        <button id="prev" class="btn">Prev</button>
        <button id="next" class="btn">Next</button>
      </div>
    </div>
  </div>

  <script>
    const WEIGHTS = {
      login_frequency: 0.25,
      feature_adoption: 0.20,
      support_ticket_volume: 0.25,
      invoice_timeliness: 0.20,
      api_usage_trend: 0.10
    };

    const state = {
      q: "", segment: "", risk: "all",
      min: 0, max: 100,
      sort: "health_score", order: "asc",
      limit: 50, offset: 0,
      rows: [],
      p25: 25, p75: 75,
      charts: new Map(),
      breakdownCache: new Map()
    };

    const persist = () => localStorage.setItem("dashState", JSON.stringify({
      q: state.q, segment: state.segment, risk: state.risk,
      min: state.min, max: state.max, sort: state.sort, order: state.order, limit: state.limit
    }));
    const restore = () => {
      try {
        const raw = localStorage.getItem("dashState");
        if (!raw) return;
        const d = JSON.parse(raw);
        Object.assign(state, d);
        document.getElementById("search").value = state.q || "";
        document.getElementById("segment").value = state.segment || "";
        document.getElementById("sort").value = state.sort;
        document.getElementById("order").textContent = state.order === "asc" ? "Asc" : "Desc";
        document.getElementById("page-size").value = String(state.limit);
        document.getElementById("score-min").value = state.min;
        document.getElementById("score-max").value = state.max;
        document.getElementById("score-min-label").textContent = state.min;
        document.getElementById("score-max-label").textContent = state.max;
        document.querySelectorAll(".risk-filter").forEach(b=>{
          b.classList.toggle("active", b.dataset.risk===state.risk);
        });
      } catch {}
    };

    const $tbody = document.getElementById("tbody");
    const $status = document.getElementById("status");
    const $error = document.getElementById("error");
    const $empty = document.getElementById("empty");
    const $pageLabel = document.getElementById("page-label");
    const $btnPrev = document.getElementById("prev");
    const $btnNext = document.getElementById("next");

    const fmtScore = s => (s==null?"—":Math.round(s));
    const segBadge = s => `<span class="seg">${s}</span>`;
    function scorePill(score){
      let cls = "risk-high";
      if (score < state.p25) cls = "risk-low";
      else if (score < state.p75) cls = "risk-mid";
      return `<span class="score-pill ${cls}">${fmtScore(score)}</span>`;
    }
    function riskBucket(score){
      if (score < state.p25) return "at_risk";
      if (score < state.p75) return "watch";
      return "healthy";
    }
    function buildUrl(){
      const u = new URL(location.origin + "/api/customers");
      u.searchParams.set("limit", state.limit);
      u.searchParams.set("offset", state.offset);
      u.searchParams.set("sort", state.sort);
      u.searchParams.set("order", state.order);
      if (state.q) u.searchParams.set("q", state.q);
      if (state.segment) u.searchParams.set("segment", state.segment);
      return u.toString();
    }
    function computePercentiles(arr){
      if (!arr.length){ state.p25=25; state.p75=75; return; }
      const xs = [...arr.map(r=>r.health_score||0)].sort((a,b)=>a-b);
      const q = p => {
        const idx = (p/100)*(xs.length-1);
        const lo = Math.floor(idx), hi = Math.ceil(idx);
        if (hi===lo) return xs[lo];
        const w = idx - lo;
        return xs[lo]*(1-w)+xs[hi]*w;
      };
      state.p25 = q(25); state.p75 = q(75);
    }
    function updateRiskCounts(arr){
      const all = arr.length;
      const risk = arr.filter(r=>riskBucket(r.health_score||0)==="at_risk").length;
      const watch = arr.filter(r=>riskBucket(r.health_score||0)==="watch").length;
      const healthy = arr.filter(r=>riskBucket(r.health_score||0)==="healthy").length;
      document.getElementById("count-all").textContent = all;
      document.getElementById("count-risk").textContent = risk;
      document.getElementById("count-watch").textContent = watch;
      document.getElementById("count-healthy").textContent = healthy;
    }

    function showStatus(kind){
      $status.style.display = kind==="loading" ? "block" : "none";
      $error.style.display  = kind==="error" ? "block" : "none";
      $empty.style.display  = "none";
    }

    function renderRows(){
      $tbody.innerHTML = "";
      const inScore = r => (r.health_score??0) >= state.min && (r.health_score??0) <= state.max;
      let rows = state.rows.filter(inScore);
      if (state.risk!=="all"){
        rows = rows.filter(r=>riskBucket(r.health_score||0)===state.risk);
      }
      if (!rows.length){ $empty.style.display="block"; return; }
      $empty.style.display="none";

      for (const r of rows){
        const tr = document.createElement("tr");
        tr.className = "data-row";
        tr.id = `row-${r.id}`;
        tr.innerHTML = `
          <td>${r.id}</td>
          <td>${r.name}</td>
          <td>${segBadge(r.segment)}</td>
          <td>${r.seats ?? "—"}</td>
          <td>${scorePill(r.health_score)}</td>
          <td class="actions">
            <button class="btn expand" data-id="${r.id}">Details</button>
            <a class="link" href="#customer-${r.id}" title="Copy link">Link</a>
          </td>
        `;
        $tbody.appendChild(tr);

        const exp = document.createElement("tr");
        exp.id = `expand-${r.id}`;
        exp.innerHTML = `<td colspan="6"><div class="expanded-cell" style="display:none"></div></td>`;
        $tbody.appendChild(exp);
      }

      document.querySelectorAll(".expand").forEach(btn=>{
        btn.onclick = async (e)=>{
          const id = Number(e.currentTarget.dataset.id);
          await toggleExpand(id);
        };
      });
    }

    function destroyChart(id){
      const ch = state.charts.get(id);
      if (ch){ ch.destroy(); state.charts.delete(id); }
    }

    function renderBreakdown(id, cell, factors){
      const labels = ["login_frequency","feature_adoption","support_ticket_volume","invoice_timeliness","api_usage_trend"];
      const pretty = {
        login_frequency:"Login Frequency",
        feature_adoption:"Feature Adoption",
        support_ticket_volume:"Ticket Volume",
        invoice_timeliness:"Invoice Timeliness",
        api_usage_trend:"API Usage Trend"
      };
      const data = labels.map(k => Math.round(factors[k] ?? 0));
      const contrib = labels.map(k => (factors[k] ?? 0) * WEIGHTS[k]);

      cell.innerHTML = `
        <div class="expanded-grid">
          <div>
            <canvas id="donut-${id}" data-chart="${id}" height="220"></canvas>
          </div>
          <div>
            <div class="mini" style="margin-bottom:10px">Health breakdown (0–100, higher is better):</div>
            ${labels.map((k,i)=>`
              <div style="display:flex;align-items:center;gap:10px;margin:6px 0">
                <div style="width:190px;color:var(--muted)">${pretty[k]} (${Math.round(WEIGHTS[k]*100)}%)</div>
                <div style="flex:1;background:#0d152b;border:1px solid var(--border);border-radius:999px;overflow:hidden;height:8px">
                  <div style="height:100%;width:${data[i]}%;background:linear-gradient(90deg,#38bdf8,#8b5cf6)"></div>
                </div>
                <div style="width:40px;text-align:right">${data[i]}</div>
              </div>
            `).join("")}
            <div class="mini" style="margin-top:12px">
              Donut shows weighted contribution of each factor to the total score.
            </div>
          </div>
        </div>
      `;
      const ctx = document.getElementById(`donut-${id}`).getContext("2d");
      const chart = new Chart(ctx, {
        type: "doughnut",
        data: { labels: labels.map(k=>pretty[k]), datasets: [{ data: contrib, borderWidth: 0 }] },
        options: {
          responsive: true,
          plugins: { legend:{position:"bottom", labels:{color:"#cbd5e1"}}, tooltip:{enabled:true} },
          cutout: "60%"
        }
      });
      state.charts.set(id, chart);
    }

    async function toggleExpand(id){
      const cell = document.querySelector(`#expand-${id} .expanded-cell`);
      const opened = cell.style.display !== "none";
      if (opened){ cell.style.display="none"; destroyChart(id); return; }

      document.querySelectorAll(".expanded-cell").forEach(n=>{
        if (n!==cell){ n.style.display="none"; }
      });
      document.querySelectorAll("canvas[data-chart]").forEach(c=>{
        const cid = Number(c.dataset.chart);
        destroyChart(cid);
      });

      cell.style.display="block";
      let factors = state.breakdownCache.get(id);
      if (!factors){
        const r = await fetch(`/api/customers/${id}/health`);
        if (!r.ok){ cell.innerHTML = `<div class="mini">Failed to load breakdown.</div>`; return; }
        const body = await r.json();
        factors = body.factors || {};
        state.breakdownCache.set(id, factors);
      }
      renderBreakdown(id, cell, factors);
      history.replaceState(null, "", `#customer-${id}`);
    }

    const debounce = (fn,ms)=>{let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};

    function updatePagination(arr){
      const page = Math.floor(state.offset / state.limit) + 1;
      document.getElementById("page-label").textContent = `Page ${page}`;
      document.getElementById("prev").disabled = state.offset<=0;
      document.getElementById("next").disabled = arr.length < state.limit;
    }

    async function fetchAndRender(){
      persist();
      showStatus("loading");
      try{
        const url = buildUrl();
        const res = await fetch(url);
        if (!res.ok) throw new Error("bad status");
        const arr = await res.json();
        computePercentiles(arr);
        updateRiskCounts(arr);
        state.rows = arr;
        renderRows();
        updatePagination(arr);
        if (!arr.length) { $empty.style.display="block"; }
        showStatus("");
        openDeepLinkOnce();
      } catch(err){
        console.error(err);
        showStatus("error");
      }
    }

    // Controls wiring
    restore();

    document.getElementById("search").addEventListener("input", debounce(e=>{
      state.q = e.target.value.trim(); state.offset=0; fetchAndRender();
    }, 300));

    document.getElementById("segment").addEventListener("change", e=>{
      state.segment = e.target.value; state.offset=0; fetchAndRender();
    });

    document.querySelectorAll(".risk-filter").forEach(b=>{
      b.addEventListener("click", ()=>{
        document.querySelectorAll(".risk-filter").forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
        state.risk = b.dataset.risk; state.offset=0; fetchAndRender();
      });
    });

    document.getElementById("score-min").addEventListener("input", e=>{
      state.min = Number(e.target.value);
      if (state.min > state.max){ state.min = state.max; e.target.value = state.min; }
      document.getElementById("score-min-label").textContent = state.min;
      renderRows();
    });
    document.getElementById("score-max").addEventListener("input", e=>{
      state.max = Number(e.target.value);
      if (state.max < state.min){ state.max = state.min; e.target.value = state.max; }
      document.getElementById("score-max-label").textContent = state.max;
      renderRows();
    });

    document.getElementById("sort").addEventListener("change", e=>{
      state.sort = e.target.value; state.offset=0; fetchAndRender();
    });
    document.getElementById("order").addEventListener("click", ()=>{
      state.order = state.order==="asc" ? "desc" : "asc";
      document.getElementById("order").textContent = state.order==="asc" ? "Asc" : "Desc";
      state.offset=0; fetchAndRender();
    });

    document.getElementById("page-size").addEventListener("change", e=>{
      state.limit = Number(e.target.value); state.offset=0; fetchAndRender();
    });
    document.getElementById("prev").addEventListener("click", ()=>{ state.offset = Math.max(0, state.offset - state.limit); fetchAndRender(); });
    document.getElementById("next").addEventListener("click", ()=>{ state.offset = state.offset + state.limit; fetchAndRender(); });

    document.getElementById("export").addEventListener("click", ()=>{
      const rows = state.rows
        .filter(r => (r.health_score??0) >= state.min && (r.health_score??0) <= state.max)
        .filter(r => state.risk==="all" || riskBucket(r.health_score||0)===state.risk);
      const header = ["id","name","segment","seats","health_score"];
      const csv = [header.join(",")].concat(rows.map(r =>
        [r.id, JSON.stringify(r.name), r.segment, r.seats ?? "", Math.round(r.health_score ?? 0)].join(",")
      )).join("\n");
      const blob = new Blob([csv], {type:"text/csv"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "customers.csv";
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // Deep link open
    let openedDeepLink = false;
    function openDeepLinkOnce(){
      if (openedDeepLink) return;
      const m = location.hash.match(/#customer-(\d+)/);
      if (m){
        const id = Number(m[1]);
        const btn = document.querySelector(`.expand[data-id="${id}"]`);
        if (btn) { openedDeepLink = true; btn.click(); }
      }
    }

    // Trend chart
    let trendChart;
    async function loadTrend() {
      const seg = document.getElementById("trend-segment").value || "";
      const url = new URL(location.origin + "/api/health/trend");
      url.searchParams.set("days", 30);
      if (seg) url.searchParams.set("segment", seg);
      const r = await fetch(url.toString());
      if (!r.ok) return;
      const data = await r.json();
      renderTrendChart(data);
      if (data.length) {
        const last = data[data.length-1];
        document.getElementById("glance").innerHTML =
          `Avg score today: <b>${Math.round(last.avg)}</b> &nbsp;|&nbsp; P25: ${Math.round(last.p25)} &nbsp;|&nbsp; P75: ${Math.round(last.p75)}`;
      }
    }
    function renderTrendChart(points){
      const labels = points.map(p=>p.date);
      const avg = points.map(p=>p.avg);
      const p25 = points.map(p=>p.p25);
      const p75 = points.map(p=>p.p75);
      const ctx = document.getElementById("trendChart").getContext("2d");
      if (trendChart) trendChart.destroy();
      trendChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Avg", data: avg, borderWidth: 2, tension: .25, fill: false },
            { label: "P25", data: p25, borderWidth: 1, borderDash:[4,4], tension: .25, fill: false },
            { label: "P75", data: p75, borderWidth: 1, borderDash:[4,4], tension: .25, fill: false },
          ]
        },
        options: {
          responsive: true,
          plugins: { legend:{labels:{color:"#cbd5e1"}} },
          scales: {
            x: { ticks:{color:"#94a3b8"}, grid:{color:"rgba(255,255,255,.06)"} },
            y: { min:0, max:100, ticks:{color:"#94a3b8"}, grid:{color:"rgba(255,255,255,.06)"} }
          }
        }
      });
    }
    document.getElementById("trend-segment").addEventListener("change", loadTrend);

    // GO!
    loadTrend();
    fetchAndRender();
  </script>
</body>
</html>
